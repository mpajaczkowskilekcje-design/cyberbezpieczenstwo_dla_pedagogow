<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Wiedzy: Nastolatki 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .option-btn:disabled { cursor: not-allowed; opacity: 0.8; }
        #qr-code img { margin: 0 auto; border: 4px solid white; border-radius: 4px; }
        .bar-transition { transition: width 0.8s ease-out; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">

    <div id="app" class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
        <!-- Header -->
        <div class="bg-indigo-700 p-6 text-white text-center relative">
            <h1 class="text-2xl font-bold">Nastolatki 3.0: Quiz Live</h1>
            <p class="text-indigo-200 text-sm">Sprawd≈∫ wyniki i zobacz, jak odpowiadajƒÖ inni</p>
            <button id="admin-toggle" class="absolute top-4 right-4 text-[10px] uppercase tracking-widest bg-indigo-800 hover:bg-black px-3 py-1 rounded-full transition-colors">
                Statystyki
            </button>
        </div>

        <div class="flex flex-col md:flex-row">
            <!-- Main Content -->
            <div id="main-content" class="flex-grow p-6 md:p-10 border-r border-slate-100">
                
                <!-- Quiz -->
                <div id="quiz-container">
                    <div class="flex justify-between items-center mb-6">
                        <span id="question-number" class="text-indigo-600 font-bold uppercase text-xs tracking-widest">Pytanie 1 / 10</span>
                        <div class="w-32 bg-slate-200 h-2 rounded-full overflow-hidden">
                            <div id="progress-fill" class="bg-indigo-500 h-full transition-all duration-500" style="width: 10%"></div>
                        </div>
                    </div>

                    <h2 id="question-text" class="text-xl font-bold text-slate-800 mb-8 leading-snug">≈Åadowanie pytania...</h2>
                    
                    <div id="options-grid" class="grid gap-4"></div>

                    <div id="feedback" class="mt-8 p-6 rounded-xl hidden border-2">
                        <p id="feedback-text" class="text-sm font-medium mb-4"></p>
                        <button id="next-btn" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition-transform active:scale-95">
                            Dalej
                        </button>
                    </div>
                </div>

                <!-- Stats View -->
                <div id="stats-area" class="hidden">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">Wyniki grupy (na ≈ºywo)</h2>
                    <div id="stats-container" class="space-y-6"></div>
                    <button id="back-to-quiz" class="mt-10 w-full py-3 text-slate-500 font-semibold hover:text-indigo-600">
                        ‚Üê Powr√≥t do pyta≈Ñ
                    </button>
                </div>

                <!-- End Screen -->
                <div id="results-area" class="hidden text-center py-10">
                    <div class="text-6xl mb-4">üèÜ</div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">Gratulacje!</h2>
                    <p class="text-slate-500 mb-8">Tw√≥j wynik: <span id="final-score" class="font-bold text-indigo-600 text-2xl"></span></p>
                    <button onclick="location.reload()" class="bg-indigo-600 text-white px-10 py-4 rounded-xl font-bold shadow-lg shadow-indigo-200">
                        Zagraj jeszcze raz
                    </button>
                </div>
            </div>

            <!-- Sidebar QR -->
            <div class="w-full md:w-72 bg-slate-50 p-8 flex flex-col items-center justify-center text-center">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-[0.2em]">Do≈ÇƒÖcz do nas</p>
                <div id="qr-code" class="bg-white p-2 rounded-lg shadow-md mb-6"></div>
                <p class="text-[11px] text-slate-400 leading-relaxed max-w-[180px]">Zeskanuj kod, aby otworzyƒá quiz na swoim telefonie</p>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, increment, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nask-quiz-v1';
        const githubUrl = "https://mpajaczkowskilekcje-design.github.io/cyberbezpieczenstwo_dla_pedagogow/";

        const quizData = [
            { id: "q1", question: "W jakim wieku przeciƒôtny polski nastolatek otrzymuje pierwszy smartfon z internetem?", options: ["7‚Äì8 lat", "9‚Äì10 lat", "11‚Äì12 lat", "Powy≈ºej 13 lat"], correct: 1, rationale: "41% dzieci otrzymuje pierwszy telefon w wieku 9-10 lat." },
            { id: "q2", question: "Ile czasu ≈õrednio spƒôdza polski nastolatek w internecie w dni powszednie?", options: ["Ok. 2h", "Ok. 3,5h", "Ok. 5h", "Ponad 8h"], correct: 2, rationale: "≈örednia to 4h 59min. Rodzice czƒôsto sƒÖdzƒÖ, ≈ºe to znacznie mniej." },
            { id: "q3", question: "Jaki procent rodzic√≥w uwa≈ºa, ≈ºe ustala zasady (a ile dzieci to potwierdza)?", options: ["90% / 85%", "57% / 21%", "30% / 30%", "20% / 60%"], correct: 1, rationale: "Istnieje ogromna r√≥≈ºnica w postrzeganiu kontroli miƒôdzy rodzicami a dzieƒámi." },
            { id: "q4", question: "Jaki procent uczni√≥w zaniedbuje obowiƒÖzki szkolne przez social media?", options: ["5%", "15%", "Ok. 30%", "70%"], correct: 2, rationale: "Ok. 34% dziewczƒÖt i 29% ch≈Çopc√≥w przyznaje siƒô do zaniedba≈Ñ." },
            { id: "q5", question: "Ilu nastolatk√≥w do≈õwiadczy≈Ço cyberprzemocy (wyzywanie/o≈õmieszanie)?", options: ["Mniej ni≈º 10%", "Ponad po≈Çowa", "Ok. 30-40%", "Blisko 90%"], correct: 2, rationale: "Tylko 44% nigdy nie do≈õwiadczy≈Ço agresji; reszta spotka≈Ça siƒô z niƒÖ w r√≥≈ºnej formie." },
            { id: "q6", question: "Ilu nastolatk√≥w spotka≈Ço siƒô na ≈ºywo z doros≈Çym poznanym tylko w sieci?", options: ["Ok. 1%", "Ok. 11%", "Ok. 25%", "Ponad 40%"], correct: 1, rationale: "Co dziewiƒÖty ucze≈Ñ decyduje siƒô na takie ryzykowne spotkanie." },
            { id: "q7", question: "Jaka jest skala otrzymywania intymnych zdjƒôƒá (sekstingu) przez uczni√≥w?", options: ["2%", "10%", "Ok. 28%", "60%"], correct: 2, rationale: "Niemal co trzeci ucze≈Ñ otrzyma≈Ç takie tre≈õci." },
            { id: "q8", question: "≈öredni wiek pierwszego kontaktu z pornografiƒÖ?", options: ["9 lat", "11 lat", "14 lat", "16 lat"], correct: 1, rationale: "≈örednia to 11 lat i 3 miesiƒÖce." },
            { id: "q9", question: "Co najbardziej niepokoi nastolatk√≥w w kontek≈õcie AI?", options: ["Trudno≈õƒá obs≈Çugi", "Brak dostƒôpu", "Zagro≈ºenie dla zawodu", "Etyka"], correct: 2, rationale: "34% boi siƒô utraty pracy w przysz≈Ço≈õci." },
            { id: "q10", question: "Ilu uczni√≥w szk√≥≈Ç ≈õrednich czuje potrzebƒô ograniczenia czasu z telefonem?", options: ["10%", "25%", "Ponad 50%", "90%"], correct: 2, rationale: "56% uczni√≥w widzi u siebie problem nadu≈ºywania smartfona." }
        ];

        let currentQuestion = 0;
        let score = 0;
        let answered = false;
        let statsUnsubscribe = null;
        let userAuth = null;

        const init = async () => {
            // Kod QR generujemy natychmiast, bez czekania na nic
            new QRCode(document.getElementById("qr-code"), {
                text: githubUrl,
                width: 140,
                height: 140,
                colorDark : "#4338ca",
                colorLight : "#f8fafc"
            });

            // Logowanie w tle - je≈õli siƒô uda, bƒôdziemy mieƒá statystyki
            signInAnonymously(auth).then(res => userAuth = res.user).catch(e => console.warn("Statystyki wy≈ÇƒÖczone (tryb offline)"));
            
            showQuestion();
        };

        const showQuestion = () => {
            const q = quizData[currentQuestion];
            document.getElementById('question-number').innerText = `Pytanie ${currentQuestion + 1} / ${quizData.length}`;
            document.getElementById('question-text').innerText = q.question;
            document.getElementById('progress-fill').style.width = `${((currentQuestion + 1) / quizData.length) * 100}%`;
            
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn text-left p-5 border-2 border-slate-200 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition-all font-medium text-slate-700";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(i, btn);
                grid.appendChild(btn);
            });
            document.getElementById('feedback').classList.add('hidden');
            answered = false;
        };

        const handleAnswer = async (index, btn) => {
            if (answered) return;
            answered = true;
            const q = quizData[currentQuestion];
            const isCorrect = index === q.correct;
            
            if (isCorrect) score++;

            // Zapisz g≈Ços je≈õli jeste≈õmy zalogowani
            if (userAuth) {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', q.id);
                getDoc(docRef).then(snap => {
                    if (!snap.exists()) setDoc(docRef, { counts: [0, 0, 0, 0] }).then(() => updateVote(docRef, index));
                    else updateVote(docRef, index);
                });
            }

            // UI feedback
            document.querySelectorAll('.option-btn').forEach((b, i) => {
                b.disabled = true;
                if (i === q.correct) b.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
                else if (i === index && !isCorrect) b.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
            });

            const fBox = document.getElementById('feedback');
            const fText = document.getElementById('feedback-text');
            fBox.className = `mt-8 p-6 rounded-xl border-2 ${isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`;
            fText.innerHTML = `<span class="block text-lg font-bold mb-1">${isCorrect ? 'Doskonale!' : 'Nie tym razem...'}</span>${q.rationale}`;
            fBox.classList.remove('hidden');
        };

        const updateVote = (ref, idx) => {
            const data = {};
            data[`counts.${idx}`] = increment(1);
            updateDoc(ref, data);
        };

        const toggleStats = () => {
            const q = document.getElementById('quiz-container');
            const s = document.getElementById('stats-area');
            const btn = document.getElementById('admin-toggle');

            if (s.classList.contains('hidden')) {
                q.classList.add('hidden');
                s.classList.remove('hidden');
                btn.innerText = "Zamknij";
                loadStats();
            } else {
                q.classList.remove('hidden');
                s.classList.add('hidden');
                btn.innerText = "Statystyki";
                if (statsUnsubscribe) statsUnsubscribe();
            }
        };

        const loadStats = () => {
            const q = quizData[currentQuestion];
            const container = document.getElementById('stats-container');
            container.innerHTML = '<p class="text-center py-10 text-slate-400 animate-pulse">Pobieranie wynik√≥w grupy...</p>';

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', q.id);
            statsUnsubscribe = onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const counts = doc.data().counts;
                    const total = counts.reduce((a, b) => a + b, 0) || 1;
                    container.innerHTML = '';
                    
                    q.options.forEach((opt, i) => {
                        const pct = Math.round((counts[i] / total) * 100);
                        const isCorrect = i === q.correct;
                        const row = document.createElement('div');
                        row.innerHTML = `
                            <div class="flex justify-between text-sm mb-2">
                                <span class="${isCorrect ? 'font-bold text-green-600' : 'text-slate-600'}">${opt} ${isCorrect ? '‚úì' : ''}</span>
                                <span class="font-bold">${pct}%</span>
                            </div>
                            <div class="w-full bg-slate-100 h-3 rounded-full">
                                <div class="bar-transition h-full ${isCorrect ? 'bg-green-500' : 'bg-indigo-400'} rounded-full" style="width: ${pct}%"></div>
                            </div>
                        `;
                        container.appendChild(row);
                    });
                } else {
                    container.innerHTML = '<p class="text-center py-10 text-slate-400">Brak oddanych g≈Ços√≥w w tej sesji.</p>';
                }
            });
        };

        document.getElementById('next-btn').onclick = () => {
            currentQuestion++;
            if (currentQuestion < quizData.length) showQuestion();
            else {
                document.getElementById('quiz-container').classList.add('hidden');
                document.getElementById('results-area').classList.remove('hidden');
                document.getElementById('final-score').innerText = `${score} / ${quizData.length}`;
            }
        };

        document.getElementById('admin-toggle').onclick = toggleStats;
        document.getElementById('back-to-quiz').onclick = toggleStats;

        init();
    </script>
</body>
</html>
