<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Wiedzy: Nastolatki 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .option-btn:disabled { cursor: not-allowed; opacity: 0.8; }
        #qr-code img { margin: 0 auto; border: 4px solid white; border-radius: 4px; }
        .bar-transition { transition: width 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #app { opacity: 0; transition: opacity 0.3s ease-in; }
        #app.visible { opacity: 1; }
        
        .stat-bar {
            height: 40px;
            border-radius: 8px;
            transition: width 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
    </style>
</head>
<body class="bg-slate-900 min-h-screen p-2 md:p-6 flex items-center justify-center">

    <div id="app" class="w-full max-w-5xl bg-white rounded-3xl shadow-2xl overflow-hidden min-h-[600px] flex flex-col">
        <!-- Header -->
        <div class="bg-indigo-600 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-xl md:text-2xl font-black tracking-tight">QUIZ LIVE: NASTOLATKI 3.0</h1>
                <p class="text-indigo-100 text-xs opacity-80 uppercase tracking-widest">Panel Edukacyjny</p>
            </div>
            <button id="admin-toggle" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl text-sm font-bold transition-all">
                Poka≈º Wyniki Grupy
            </button>
        </div>

        <div class="flex flex-col lg:flex-row flex-grow">
            <!-- Main Content -->
            <div id="main-content" class="flex-grow p-6 md:p-10 border-r border-slate-100">
                
                <!-- QUIZ INTERFEJS -->
                <div id="quiz-container">
                    <div class="flex justify-between items-center mb-8">
                        <span id="question-number" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-bold text-xs uppercase">Pytanie 1 / 10</span>
                        <div class="flex items-center gap-2">
                            <div class="w-32 bg-slate-100 h-2 rounded-full overflow-hidden">
                                <div id="progress-fill" class="bg-indigo-500 h-full transition-all duration-500" style="width: 10%"></div>
                            </div>
                        </div>
                    </div>

                    <h2 id="question-text" class="text-2xl md:text-3xl font-extrabold text-slate-800 mb-10 leading-tight italic">Inicjalizacja systemu...</h2>
                    
                    <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

                    <div id="feedback" class="mt-8 p-6 rounded-2xl hidden border-l-8 transition-all">
                        <p id="feedback-text" class="text-slate-700"></p>
                        <button id="next-btn" class="mt-6 w-full bg-slate-900 text-white py-4 rounded-xl font-black hover:bg-indigo-600 transition-all uppercase tracking-widest shadow-lg">
                            Dalej
                        </button>
                    </div>
                </div>

                <!-- PANEL WYNIK√ìW (LIVE STATS) -->
                <div id="stats-area" class="hidden">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-2xl font-black text-slate-800">Wyniki ca≈Çej grupy</h2>
                        <span id="live-indicator" class="flex items-center gap-2 text-slate-400 font-bold text-xs">
                            <span class="w-2 h-2 bg-slate-400 rounded-full animate-pulse"></span> ≈ÅƒÑCZENIE...
                        </span>
                    </div>
                    
                    <div id="stats-container" class="space-y-6"></div>

                    <div class="mt-8 p-6 bg-indigo-50 rounded-2xl border border-indigo-100">
                        <h3 class="font-bold text-indigo-900 mb-2">Komentarz ekspercki:</h3>
                        <p id="stats-rationale" class="text-indigo-800/80 text-sm italic"></p>
                    </div>

                    <button id="back-to-quiz" class="mt-8 text-slate-400 font-bold hover:text-indigo-600 transition-colors uppercase text-[10px] tracking-[0.2em]">
                        ‚Üê Powr√≥t do moich odpowiedzi
                    </button>
                </div>

                <!-- EKRAN KO≈ÉCOWY -->
                <div id="results-area" class="hidden text-center py-20">
                    <div class="text-8xl mb-6">üèÜ</div>
                    <h2 class="text-4xl font-black text-slate-800 mb-2">Gratulacje!</h2>
                    <p class="text-slate-500 text-lg mb-10">Tw√≥j wynik: <span id="final-score" class="text-indigo-600 font-black"></span></p>
                    <button onclick="location.reload()" class="bg-indigo-600 text-white px-12 py-5 rounded-2xl font-black shadow-2xl hover:scale-105 transition-transform uppercase tracking-wider">
                        Zagraj jeszcze raz
                    </button>
                </div>
            </div>

            <!-- Sidebar QR -->
            <div id="qr-sidebar" class="w-full lg:w-80 bg-slate-50 p-10 flex flex-col items-center justify-center text-center">
                <div class="mb-6">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] mb-4">Skanuj i odpowiedz</p>
                    <div id="qr-code" class="bg-white p-4 rounded-3xl shadow-xl inline-block border-4 border-white"></div>
                </div>
                <h3 class="font-black text-slate-800 text-lg mb-2">G≈Çosowanie LIVE</h3>
                <p class="text-xs text-slate-500 leading-relaxed mb-6">Uczniowie skanujƒÖ kod, aby oddawaƒá g≈Çosy na swoich urzƒÖdzeniach.</p>
                <div id="connection-status" class="px-4 py-2 bg-slate-200 rounded-full text-[10px] text-slate-500 font-bold uppercase tracking-widest">
                    Status: Czekam...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, increment, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const quizData = [
            { id: "q1", question: "W jakim wieku przeciƒôtny polski nastolatek otrzymuje pierwszy smartfon z internetem?", options: ["7‚Äì8 lat", "9‚Äì10 lat", "11‚Äì12 lat", "Powy≈ºej 13 lat"], correct: 1, rationale: "41% dzieci otrzymuje pierwszy telefon w wieku 9-10 lat." },
            { id: "q2", question: "Ile czasu ≈õrednio spƒôdza polski nastolatek w internecie w dni powszednie?", options: ["Ok. 2h", "Ok. 3,5h", "Ok. 5h", "Ponad 8h"], correct: 2, rationale: "≈örednia to 4h 59min. Rodzice czƒôsto sƒÖdzƒÖ, ≈ºe to znacznie mniej." },
            { id: "q3", question: "Jaki procent rodzic√≥w uwa≈ºa, ≈ºe ustala zasady (a ile dzieci to potwierdza)?", options: ["90% / 85%", "57% / 21%", "30% / 30%", "20% / 60%"], correct: 1, rationale: "Ogromna rozbie≈ºno≈õƒá: 57% rodzic√≥w twierdzi, ≈ºe kontroluje czas, ale tylko 21% dzieci to potwierdza." },
            { id: "q4", question: "Jaki procent uczni√≥w zaniedbuje obowiƒÖzki szkolne przez social media?", options: ["5%", "15%", "Ok. 30%", "70%"], correct: 2, rationale: "Prawie 1/3 uczni√≥w przyznaje, ≈ºe internet odciƒÖga ich od nauki." },
            { id: "q5", question: "Ilu nastolatk√≥w do≈õwiadczy≈Ço cyberprzemocy (wyzywanie/o≈õmieszanie)?", options: ["Mniej ni≈º 10%", "Ponad po≈Çowa", "Ok. 30-40%", "Blisko 90%"], correct: 2, rationale: "Tylko 44% nigdy nie do≈õwiadczy≈Ço agresji; reszta spotka≈Ça siƒô z niƒÖ w r√≥≈ºnej formie." },
            { id: "q6", question: "Ilu nastolatk√≥w spotka≈Ço siƒô na ≈ºywo z doros≈Çym poznanym tylko w sieci?", options: ["Ok. 1%", "Ok. 11%", "Ok. 25%", "Ponad 40%"], correct: 1, rationale: "Co dziewiƒÖty ucze≈Ñ decyduje siƒô na takie ryzykowne spotkanie." },
            { id: "q7", question: "Jaka jest skala sekstingu (otrzymywania intymnych zdjƒôƒá) w≈õr√≥d uczni√≥w?", options: ["2%", "10%", "Ok. 28%", "60%"], correct: 2, rationale: "Niemal co trzeci ucze≈Ñ otrzyma≈Ç kiedykolwiek takie tre≈õci." },
            { id: "q8", question: "≈öredni wiek pierwszego kontaktu z pornografiƒÖ?", options: ["9 lat", "11 lat", "14 lat", "16 lat"], correct: 1, rationale: "≈öredni wiek to zaledwie 11 lat i 3 miesiƒÖce." },
            { id: "q9", question: "Co najbardziej niepokoi nastolatk√≥w w kontek≈õcie AI?", options: ["Trudno≈õƒá obs≈Çugi", "Brak dostƒôpu", "Zagro≈ºenie dla zawodu", "Etyka"], correct: 2, rationale: "34% boi siƒô, ≈ºe AI odbierze im pracƒô w przysz≈Ço≈õci." },
            { id: "q10", question: "Ilu uczni√≥w czuje potrzebƒô ograniczenia czasu z telefonem?", options: ["10%", "25%", "Ponad 50%", "90%"], correct: 2, rationale: "A≈º 56% uczni√≥w widzi u siebie problem nadu≈ºywania smartfona." }
        ];

        const githubUrl = "https://mpajaczkowskilekcje-design.github.io/cyberbezpieczenstwo_dla_pedagogow/";
        let currentQuestion = 0;
        let score = 0;
        let answered = false;
        let statsUnsubscribe = null;
        let db, auth, user = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nask-kahoot-live-v3';

        // Gwarancja uwierzytelnienia przed startem
        const initAuth = () => {
            return new Promise(async (resolve) => {
                try {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, (u) => {
                        if (u) {
                            user = u;
                            resolve(true);
                        }
                    });

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Auth Fail", e);
                    resolve(false);
                }
            });
        };

        const initApp = async () => {
            document.getElementById('app').classList.add('visible');
            const statusEl = document.getElementById('connection-status');
            
            // Kod QR
            new QRCode(document.getElementById("qr-code"), {
                text: githubUrl,
                width: 160,
                height: 160,
                colorDark : "#4f46e5",
                colorLight : "#f1f5f9"
            });

            // Czekaj na baze
            const authed = await initAuth();
            if (authed) {
                statusEl.innerText = "Status: Aktywny";
                statusEl.className = "px-4 py-2 bg-green-100 rounded-full text-[10px] text-green-600 font-bold uppercase tracking-widest";
            } else {
                statusEl.innerText = "Status: Offline";
                statusEl.className = "px-4 py-2 bg-red-100 rounded-full text-[10px] text-red-600 font-bold uppercase tracking-widest";
            }

            showQuestion();
        };

        const showQuestion = () => {
            const q = quizData[currentQuestion];
            document.getElementById('question-number').innerText = `Pytanie ${currentQuestion + 1} / ${quizData.length}`;
            document.getElementById('question-text').innerText = q.question;
            document.getElementById('progress-fill').style.width = `${((currentQuestion + 1) / quizData.length) * 100}%`;
            
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                const colors = ['bg-rose-500', 'bg-sky-500', 'bg-amber-500', 'bg-emerald-500'];
                btn.className = `option-btn group relative flex items-center p-5 rounded-2xl border-b-4 border-black/20 text-white font-bold text-lg transition-all active:translate-y-1 active:border-b-0 hover:brightness-110 ${colors[i]}`;
                btn.innerHTML = `
                    <span class="w-8 h-8 rounded-lg bg-white/20 flex items-center justify-center mr-4 shrink-0">${i+1}</span>
                    <span class="text-left text-sm md:text-base">${opt}</span>
                `;
                btn.onclick = () => handleAnswer(i, btn);
                grid.appendChild(btn);
            });
            document.getElementById('feedback').classList.add('hidden');
            answered = false;
        };

        const handleAnswer = async (index, btn) => {
            if (answered) return;
            answered = true;
            const q = quizData[currentQuestion];
            const isCorrect = index === q.correct;
            if (isCorrect) score++;

            // Wysy≈Çanie g≈Çosu
            if (user && db) {
                try {
                    const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', q.id);
                    const snap = await getDoc(statsRef);
                    if (!snap.exists()) {
                        await setDoc(statsRef, { counts: [0, 0, 0, 0] });
                    }
                    const updateData = {};
                    updateData[`counts.${index}`] = increment(1);
                    await updateDoc(statsRef, updateData);
                } catch (e) {
                    console.error("Firestore Update Error:", e);
                }
            }

            // UI
            document.querySelectorAll('.option-btn').forEach((b, i) => {
                b.disabled = true;
                if (i !== index) b.style.opacity = "0.2";
                if (i === q.correct) {
                    b.style.opacity = "1";
                    b.classList.add('ring-4', 'ring-indigo-600', 'ring-offset-2');
                }
            });

            const fBox = document.getElementById('feedback');
            const fText = document.getElementById('feedback-text');
            fBox.className = `mt-8 p-6 rounded-2xl border-l-8 hidden ${isCorrect ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`;
            fText.innerHTML = `<b class="text-lg block mb-1">${isCorrect ? 'Dobrze!' : 'Nie ca≈Çkiem...'}</b> <span class="text-sm">${q.rationale}</span>`;
            fBox.classList.remove('hidden');
        };

        const loadStats = () => {
            const q = quizData[currentQuestion];
            const container = document.getElementById('stats-container');
            const indicator = document.getElementById('live-indicator');
            const rationaleText = document.getElementById('stats-rationale');
            
            rationaleText.innerText = q.rationale;
            container.innerHTML = '<div class="text-center py-10 text-slate-400 text-sm">Pobieranie danych z chmury...</div>';

            if (!db || !user) {
                container.innerHTML = '<div class="text-center py-10 text-red-500 font-bold">B≈ÇƒÖd po≈ÇƒÖczenia z bazƒÖ danych.</div>';
                return;
            }

            const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', q.id);
            
            statsUnsubscribe = onSnapshot(statsRef, (docSnap) => {
                indicator.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> TRANSMISJA NA ≈ªYWO';
                indicator.className = "flex items-center gap-2 text-red-600 font-bold text-[10px] tracking-widest";

                if (docSnap.exists()) {
                    const counts = docSnap.data().counts || [0, 0, 0, 0];
                    const total = counts.reduce((a, b) => a + b, 0) || 1;
                    container.innerHTML = '';
                    
                    const colors = ['bg-rose-500', 'bg-sky-500', 'bg-amber-500', 'bg-emerald-500'];
                    q.options.forEach((opt, i) => {
                        const pct = Math.round((counts[i] / total) * 100);
                        const isCorrect = i === q.correct;
                        const row = document.createElement('div');
                        row.className = "space-y-1";
                        row.innerHTML = `
                            <div class="flex justify-between text-[11px] font-bold text-slate-500 uppercase tracking-tight">
                                <span class="${isCorrect ? 'text-green-600' : ''}">${isCorrect ? '‚úì ' : ''}${opt}</span>
                                <span>${counts[i]} os.</span>
                            </div>
                            <div class="w-full bg-slate-100 h-8 rounded-lg overflow-hidden flex items-center">
                                <div class="stat-bar bar-transition ${colors[i]} flex items-center justify-end pr-3 text-white font-black text-xs" style="width: ${pct}%">
                                    ${pct > 15 ? pct + '%' : ''}
                                </div>
                                ${pct <= 15 ? `<span class="ml-2 font-bold text-slate-400 text-[10px]">${pct}%</span>` : ''}
                            </div>
                        `;
                        container.appendChild(row);
                    });
                } else {
                    container.innerHTML = '<div class="text-center py-16 text-slate-300 font-bold uppercase text-xs tracking-widest">Nikt jeszcze nie zag≈Çosowa≈Ç.</div>';
                }
            }, (err) => {
                indicator.innerText = "B≈ÅƒÑD PO≈ÅƒÑCZENIA";
                console.error(err);
            });
        };

        const toggleStats = () => {
            const qC = document.getElementById('quiz-container');
            const sA = document.getElementById('stats-area');
            const btn = document.getElementById('admin-toggle');

            if (sA.classList.contains('hidden')) {
                qC.classList.add('hidden');
                sA.classList.remove('hidden');
                btn.innerText = "Powr√≥t do Quizu";
                loadStats();
            } else {
                qC.classList.remove('hidden');
                sA.classList.add('hidden');
                btn.innerText = "Poka≈º Wyniki Grupy";
                if (statsUnsubscribe) statsUnsubscribe();
            }
        };

        document.getElementById('next-btn').onclick = () => {
            currentQuestion++;
            if (currentQuestion < quizData.length) {
                showQuestion();
            } else {
                document.getElementById('quiz-container').classList.add('hidden');
                document.getElementById('stats-area').classList.add('hidden');
                document.getElementById('results-area').classList.remove('hidden');
                document.getElementById('final-score').innerText = `${score} / ${quizData.length}`;
            }
        };

        document.getElementById('admin-toggle').onclick = toggleStats;
        document.getElementById('back-to-quiz').onclick = toggleStats;

        initApp();
    </script>
</body>
</html>
